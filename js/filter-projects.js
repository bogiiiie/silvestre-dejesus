/**
 * FILTER-PROJECTS.JS
 * This file handles filtering of dynamically generated project cards.
 * IMPORTANT: This must run AFTER cards are generated by shared-projects.js
 */

// Wait for cards to be generated before initializing filters
function initializeFilters() {
    console.log('üéØ Initializing project filters...');
    
    const filterTabs = document.querySelectorAll('.filter-tab');
    const noResults = document.getElementById('no-results');
    
    // Check if we're on projects page (has filter tabs)
    if (filterTabs.length === 0) {
        console.log('‚ÑπÔ∏è No filter tabs found - not on projects page');
        return;
    }
    
    let activeFilters = {
        category: 'all',
        location: 'all'
    };
    
    // Function to get ALL current project card wrappers
    function getProjectCards() {
        return document.querySelectorAll('.project-card__wrapper');
    }
    
    // Initialize filter tabs
    filterTabs.forEach(tab => {
        tab.addEventListener('click', function () {
            const filterType = this.getAttribute('data-type');
            const filterValue = this.getAttribute('data-filter');
            
            console.log(`üîç Filter clicked: ${filterType} = ${filterValue}`);
            
            // Update active tab styling
            filterTabs.forEach(t => {
                if (t.getAttribute('data-type') === filterType) {
                    t.classList.remove('ring-black', 'bg-black', 'text-white');
                    t.classList.add('ring-border');
                    t.setAttribute('aria-selected', 'false');
                }
            });
            
            this.classList.remove('ring-border');
            this.classList.add('ring-black', 'bg-black', 'text-white');
            this.setAttribute('aria-selected', 'true');
            
            // Update active filters
            activeFilters[filterType] = filterValue;
            
            // Filter projects
            filterProjects();
        });
    });
    
    // Filter function - gets fresh cards each time
    function filterProjects() {
        const projectCards = getProjectCards();
        let visibleCount = 0;
        
        console.log(`üîç Filtering ${projectCards.length} projects...`);
        console.log(`Active filters: Category=${activeFilters.category}, Location=${activeFilters.location}`);
        
        projectCards.forEach(wrapper => {
            // Get the project card inside the wrapper
            const card = wrapper.querySelector('.project-card');
            if (!card) {
                console.warn('‚ö†Ô∏è No .project-card found in wrapper');
                return;
            }
            
            const category = card.getAttribute('data-category');
            const location = card.getAttribute('data-location');
            
            const categoryMatch = activeFilters.category === 'all' || activeFilters.category === category;
            const locationMatch = activeFilters.location === 'all' || activeFilters.location === location;
            
            if (categoryMatch && locationMatch) {
                wrapper.style.display = 'block';
                wrapper.setAttribute('aria-hidden', 'false');
                visibleCount++;
            } else {
                wrapper.style.display = 'none';
                wrapper.setAttribute('aria-hidden', 'true');
            }
        });
        
        console.log(`‚úÖ ${visibleCount} projects visible after filtering`);
        
        // Show/hide no results message
        if (noResults) {
            if (visibleCount === 0) {
                noResults.classList.remove('hidden');
                noResults.setAttribute('aria-hidden', 'false');
                console.log('üì≠ No results found');
            } else {
                noResults.classList.add('hidden');
                noResults.setAttribute('aria-hidden', 'true');
            }
        }
        
        // Announce filter results for screen readers
        const resultsMessage = `${visibleCount} projects found matching your filters.`;
        announceResults(resultsMessage);
        
        // Update keyboard navigation for newly visible cards
        updateKeyboardNavigation();
    }
    
    function announceResults(message) {
        const announcement = document.createElement('div');
        announcement.setAttribute('aria-live', 'polite');
        announcement.setAttribute('aria-atomic', 'true');
        announcement.classList.add('sr-only');
        announcement.textContent = message;
        
        document.body.appendChild(announcement);
        
        setTimeout(() => {
            document.body.removeChild(announcement);
        }, 1000);
    }
    
    // Update keyboard navigation for visible cards
    function updateKeyboardNavigation() {
        const projectCards = getProjectCards();
        const visibleCards = Array.from(projectCards).filter(wrapper => 
            wrapper.style.display !== 'none'
        );
        
        visibleCards.forEach((wrapper, index) => {
            const card = wrapper.querySelector('.project-card');
            if (!card) return;
            
            card.setAttribute('tabindex', '0');
            
            // Remove existing listeners to prevent duplicates
            const newCard = card.cloneNode(true);
            card.parentNode.replaceChild(newCard, card);
            
            // Add new listeners
            newCard.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const onclickValue = this.getAttribute('onclick');
                    if (onclickValue) {
                        const match = onclickValue.match(/openModal\((\d+)\)/);
                        if (match) {
                            const projectIndex = parseInt(match[1]);
                            if (window.openModal) {
                                window.openModal(projectIndex);
                            }
                        }
                    }
                } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    const nextIndex = (index + 1) % visibleCards.length;
                    const nextCard = visibleCards[nextIndex].querySelector('.project-card');
                    if (nextCard) nextCard.focus();
                } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    const prevIndex = (index - 1 + visibleCards.length) % visibleCards.length;
                    const prevCard = visibleCards[prevIndex].querySelector('.project-card');
                    if (prevCard) prevCard.focus();
                }
            });
        });
    }
    
    // Keyboard navigation for filter tabs
    filterTabs.forEach((tab, index) => {
        tab.addEventListener('keydown', function (e) {
            if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                e.preventDefault();
                const nextTab = filterTabs[(index + 1) % filterTabs.length];
                nextTab.focus();
            } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                e.preventDefault();
                const prevIndex = (index - 1 + filterTabs.length) % filterTabs.length;
                const prevTab = filterTabs[prevIndex];
                prevTab.focus();
            } else if (e.key === 'Home') {
                e.preventDefault();
                filterTabs[0].focus();
            } else if (e.key === 'End') {
                e.preventDefault();
                filterTabs[filterTabs.length - 1].focus();
            } else if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });
    
    // Initial filter (show all projects)
    console.log('üéØ Running initial filter...');
    filterProjects();
    
    // Export filterProjects for manual refreshing if needed
    window.filterProjects = filterProjects;
}

// Wait for DOM and cards to be ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('üè† DOM loaded, waiting for project cards...');
    
    // Wait a bit for cards to be generated by shared-projects.js
    // We'll check every 100ms for up to 5 seconds
    let checkCount = 0;
    const maxChecks = 50; // 5 seconds max
    const checkInterval = 100; // ms
    
    const checkForCards = setInterval(() => {
        const cardsExist = document.querySelectorAll('.project-card__wrapper').length > 0;
        const hasFilterTabs = document.querySelectorAll('.filter-tab').length > 0;
        
        if (cardsExist && hasFilterTabs) {
            console.log('‚úÖ Project cards found, initializing filters...');
            clearInterval(checkForCards);
            initializeFilters();
        } else if (checkCount >= maxChecks) {
            console.log('‚è∞ Timeout waiting for project cards');
            clearInterval(checkForCards);
            if (hasFilterTabs) {
                console.log('‚ö†Ô∏è No cards found but filter tabs exist');
            }
        }
        
        checkCount++;
    }, checkInterval);
});

// Export for manual initialization if needed
window.initializeFilters = initializeFilters;